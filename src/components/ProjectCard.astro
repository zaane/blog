---
import { YouTube } from "astro-embed";
import type { Project } from "../types/projects";
import { renderMarkdown } from "../lib/markdown";

interface Props {
  project: Project;
}

const { project } = Astro.props as Props;
const hasFeatures = (project.currentFeatures?.length ?? 0) > 0;
const hasRoadmap = (project.nextSteps?.length ?? 0) > 0;
const hasFrontendTools = (project.techStack?.frontend?.length ?? 0) > 0;
const hasBackendTools = (project.techStack?.backend?.length ?? 0) > 0;
const hasTechStack = hasFrontendTools || hasBackendTools;
const hasGuidedWhatItIs = Boolean(project.whatItIs);
const hasGuidedLearned = Boolean(project.whatILearned);
const hasGuidedNotes = Boolean(project.otherNotes);
const isGuidedEntry = hasGuidedWhatItIs || hasGuidedLearned || hasGuidedNotes;
const imageSrc = project.image?.src ?? project.imageUrl;
const showsImage = Boolean(!project.videoUrl && imageSrc);
const shouldFitImageToRow = Boolean(showsImage && !project.description);
const hasMedia = Boolean(project.videoUrl || imageSrc || project.videoLabel);
const hasMainText = Boolean(project.description || project.externalUrl);
const isComingSoon =
  !hasMedia &&
  !hasMainText &&
  !hasFeatures &&
  !hasRoadmap &&
  !hasTechStack &&
  !isGuidedEntry;
const statusClass =
  project.status === "Open Source" ? "status-open" : "status-closed";
const showHeaderExternalLink = Boolean(project.externalUrl && isGuidedEntry);
const descriptionHtml = await renderMarkdown(project.description);
const whatItIsHtml = await renderMarkdown(project.whatItIs);
const whatILearnedHtml = await renderMarkdown(project.whatILearned);
const otherNotesHtml = await renderMarkdown(project.otherNotes);
---

<article class={`project-card ${showsImage ? "project-card-has-image" : ""} ${isComingSoon ? "coming-soon" : ""}`}>
  {
    isComingSoon ? (
      <>
        <h3 class="coming-soon-title">{project.name}</h3>
        <p class="coming-soon-description">Details coming soon</p>
      </>
    ) : (
      <>
        <header class="project-card-head">
          <h3 class="project-name">{project.name}</h3>
          {
            showHeaderExternalLink ? (
              <a
                href={project.externalUrl}
                class="project-header-link"
                target="_blank"
                rel="noreferrer noopener"
              >
                link â†—
              </a>
            ) : project.status ? (
              <span class={`project-status ${statusClass}`}>{project.status}</span>
            ) : null
          }
        </header>

        {
          hasMedia || hasMainText ? (
            <div
              class={`project-main-content ${shouldFitImageToRow ? "project-main-content-image-fit" : ""}`}
            >
              {
                project.videoUrl ? (
                  <YouTube
                    id={project.videoUrl}
                    title={project.videoTitle ?? `${project.name} demo video`}
                    posterQuality={project.videoPosterQuality ?? "high"}
                    class="project-video project-video-embed"
                  />
                ) : imageSrc ? (
                  <img
                    src={imageSrc}
                    alt={project.imageAlt ?? `${project.name} preview image`}
                    width={project.image?.width}
                    height={project.image?.height}
                    class="project-image"
                    loading="lazy"
                  />
                ) : project.videoLabel ? (
                  <div
                    class="project-video project-video-placeholder"
                    role="img"
                    aria-label={`Media placeholder for ${project.name}`}
                  >
                    {project.videoLabel}
                  </div>
                ) : null
              }

              {
                project.description ? (
                  <div class="project-description" set:html={descriptionHtml} />
                ) : null
              }

              {
                project.externalUrl && !showHeaderExternalLink ? (
                  <a
                    href={project.externalUrl}
                    class="project-external-link"
                    target="_blank"
                    rel="noreferrer noopener"
                  >
                    {project.externalLabel ?? "Visit course/project site"}
                  </a>
                ) : null
              }
            </div>
          ) : null
        }

        {
          !isGuidedEntry && hasFeatures ? (
            <section class="project-block project-block-features">
              <h4>Features</h4>
              <ul class="project-bullets">
                {(project.currentFeatures ?? []).map((feature) => <li>{feature}</li>)}
              </ul>
            </section>
          ) : null
        }

        {
          !isGuidedEntry && hasRoadmap ? (
            <section class="project-block project-block-roadmap">
              <h4>Roadmap</h4>
              <ul class="project-bullets">
                {(project.nextSteps ?? []).map((step) => <li>{step}</li>)}
              </ul>
            </section>
          ) : null
        }

        {
          !isGuidedEntry && hasTechStack ? (
            <section class="project-block project-block-tech project-tech-stack">
              {
                hasFrontendTools ? (
                  <section class="project-subblock project-subblock-frontend">
                    <h4>Frontend</h4>
                    <ul class="project-bullets">
                      {(project.techStack?.frontend ?? []).map((tool) => <li>{tool}</li>)}
                    </ul>
                  </section>
                ) : null
              }
              {
                hasBackendTools ? (
                  <section class="project-subblock project-subblock-backend">
                    <h4>Backend</h4>
                    <ul class="project-bullets">
                      {(project.techStack?.backend ?? []).map((tool) => <li>{tool}</li>)}
                    </ul>
                  </section>
                ) : null
              }
            </section>
          ) : null
        }

        {
          isGuidedEntry && hasGuidedWhatItIs ? (
            <section class="project-block project-block-features">
              <h4>What it is</h4>
              <div class="project-paragraph" set:html={whatItIsHtml} />
            </section>
          ) : null
        }

        {
          isGuidedEntry && hasGuidedLearned ? (
            <section class="project-block project-block-roadmap project-block-guided-learned">
              <h4>What I learned</h4>
              <div class="project-paragraph" set:html={whatILearnedHtml} />
            </section>
          ) : null
        }

        {
          isGuidedEntry && hasGuidedNotes ? (
            <section class="project-block project-block-tech project-block-guided-notes">
              <h4>Other notes</h4>
              <div class="project-paragraph" set:html={otherNotesHtml} />
            </section>
          ) : null
        }
      </>
    )
  }
</article>
